var R=Object.defineProperty;var M=(a,t,e)=>t in a?R(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var s=(a,t,e)=>M(a,typeof t!="symbol"?t+"":t,e);import{I as v,K as n,M as b}from"./index-CbeQbDky.js";class T{static checkCollision(t,e){return t.x<e.x+e.width&&t.x+t.width>e.x&&t.y<e.y+e.height&&t.y+t.height>e.y}static isPointInRect(t,e,i){return t>=i.x&&t<=i.x+i.width&&e>=i.y&&e<=i.y+i.height}static applyGravity(t,e,i){t.y+=e*i}static handleGroundCollision(t,e,i,r){return t.y+i>r?(t.y=r-i,e.y=0,!0):!1}}class w{constructor(t,e,i,r,h="#000000"){s(this,"x");s(this,"y");s(this,"width");s(this,"height");s(this,"color");this.x=t,this.y=e,this.width=i,this.height=r,this.color=h}update(t){}render(t){t.fillStyle=this.color,t.fillRect(this.x,this.y,this.width,this.height)}getRect(){return{x:this.x,y:this.y,width:this.width,height:this.height}}getX(){return this.x}getY(){return this.y}getWidth(){return this.width}getHeight(){return this.height}setPosition(t,e){this.x=t,this.y=e}}class X extends w{constructor(e,i,r,h,o){super(e,i,r,h,"#66cdaa");s(this,"velocity");s(this,"isJumping");s(this,"isOnGround");s(this,"jumpForce");s(this,"moveSpeed");s(this,"gravity");s(this,"groundY");s(this,"animationTime",0);this.velocity={x:0,y:0},this.isJumping=!1,this.isOnGround=!0,this.jumpForce=-550,this.moveSpeed=250,this.gravity=980,this.groundY=o}update(e){const i=v.getInstance();this.animationTime+=e,this.velocity.x=0,i.isKeyDown(n.LEFT)&&(this.velocity.x=-this.moveSpeed),i.isKeyDown(n.RIGHT)&&(this.velocity.x=this.moveSpeed),(i.isKeyPressed(n.UP)||i.isKeyPressed(n.SPACE))&&this.isOnGround&&(this.velocity.y=this.jumpForce,this.isJumping=!0,this.isOnGround=!1),T.applyGravity(this.velocity,this.gravity,e),this.x+=this.velocity.x*e,this.y+=this.velocity.y*e,this.y+this.height>this.groundY&&(this.y=this.groundY-this.height,this.velocity.y=0,this.isOnGround=!0,this.isJumping=!1),this.x<0&&(this.x=0)}render(e){e.fillStyle=this.color;let i=1;this.isJumping?i=1.1:this.isOnGround&&(i=.9+.1*Math.sin(this.animationTime*5));const r=this.x+this.width/2,h=this.y+this.height/2,o=this.width/2,P=this.height/2*i;e.beginPath(),e.ellipse(r,h,o,P,0,0,Math.PI*2),e.fill(),e.fillStyle="#ffffff";const S=this.width/8,d=this.width/5,f=-this.height/8;e.beginPath(),e.arc(r-d,h+f,S,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(r+d,h+f,S,0,Math.PI*2),e.fill(),e.fillStyle="#000000";const p=S/2;let m=0;this.velocity.x>0?m=p/2:this.velocity.x<0&&(m=-p/2),e.beginPath(),e.arc(r-d+m,h+f,p,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(r+d+m,h+f,p,0,Math.PI*2),e.fill();const u=h+this.height/5,c=this.width/4,g=this.height/10;e.strokeStyle="#000000",e.lineWidth=2,e.beginPath(),e.moveTo(r-c/2,u-g/3),e.bezierCurveTo(r-c/4,u+g/2,r,u-g/4,r,u),e.bezierCurveTo(r,u-g/4,r+c/4,u+g/2,r+c/2,u-g/3),e.stroke()}isJumpingState(){return this.isJumping}getVelocityY(){return this.velocity.y}setVelocityY(e){this.velocity.y=e}setVelocityX(e){this.velocity.x=e}getMoveSpeed(){return this.moveSpeed}jump(){this.isOnGround&&(this.velocity.y=this.jumpForce,this.isJumping=!0,this.isOnGround=!1)}setOnGround(e){this.isOnGround=e,e&&(this.isJumping=!1)}isOnGroundState(){return this.isOnGround}reset(e,i){this.x=e,this.y=i,this.velocity.x=0,this.velocity.y=0,this.isJumping=!1,this.isOnGround=!0,this.animationTime=0}}class l extends w{constructor(t,e,i,r){super(t,e,i,r,"#8B4513")}update(t){}}class y extends w{constructor(t,e,i,r){super(t,e,i,r,"#FF0000")}update(t){}}class C extends w{constructor(e,i,r,h){super(e,i,r,h,"#FFD700");s(this,"animationTime",0);s(this,"glowIntensity",0)}update(e){this.animationTime+=e,this.glowIntensity=Math.abs(Math.sin(this.animationTime*2))}render(e){e.fillStyle=this.color,e.fillRect(this.x,this.y,this.width,this.height),e.fillStyle="#8B4513",e.fillRect(this.x,this.y,this.width,this.height/3),e.fillStyle="#C0C0C0",e.fillRect(this.x+this.width/2-5,this.y+this.height/3-5,10,10),e.fillStyle=`rgba(255, 255, 255, ${this.glowIntensity*.3})`,e.beginPath(),e.arc(this.x+this.width/2,this.y+this.height/2,this.width/2+10*this.glowIntensity,0,Math.PI*2),e.fill()}}class G{constructor(){s(this,"game",null);s(this,"player",null);s(this,"grounds",[]);s(this,"traps",[]);s(this,"treasure",null);s(this,"gameState",0);s(this,"startTime",0);s(this,"endTime",0);s(this,"cameraX",0);s(this,"levelWidth",3e3);s(this,"autoScrollSpeed",150);s(this,"retryKeyReleased",!0);s(this,"autoMoveSpeed",200);s(this,"backToMenuRequested",!1)}init(t){this.game=t,this.startTime=performance.now(),this.gameState=0,this.cameraX=0,this.retryKeyReleased=!0,this.backToMenuRequested=!1;const e=t.getCanvas(),i=e.height-50;v.getInstance().setCanvas(e),this.player=new X(50,i-40,30,40,i),this.grounds=[],this.grounds.push(new l(0,i,500,50)),this.grounds.push(new l(600,i,400,50)),this.grounds.push(new l(1100,i,300,50)),this.grounds.push(new l(1500,i,200,50)),this.grounds.push(new l(1800,i,400,50)),this.grounds.push(new l(2300,i,700,50)),this.grounds.push(new l(550,i-100,100,20)),this.grounds.push(new l(1050,i-120,80,20)),this.grounds.push(new l(1450,i-150,70,20)),this.grounds.push(new l(1750,i-180,60,20)),this.traps=[],this.traps.push(new y(500,i-10,100,10)),this.traps.push(new y(1e3,i-10,100,10)),this.traps.push(new y(1400,i-10,100,10)),this.traps.push(new y(1700,i-10,100,10)),this.traps.push(new y(2200,i-10,100,10)),this.treasure=new C(2800,i-50,50,50)}update(t){const e=v.getInstance();if(e.isKeyPressed(n.ESC)&&(this.backToMenuRequested=!0),this.backToMenuRequested){this.returnToMenu();return}if(this.gameState===1||this.gameState===2){if((e.isKeyPressed(n.SPACE)||e.isKeyPressed(n.UP)||e.isKeyPressed(n.R)||e.isKeyPressed(n.TOUCH_RETRY))&&this.retryKeyReleased){this.reset();return}(e.isKeyReleased(n.SPACE)||e.isKeyReleased(n.UP)||e.isKeyReleased(n.R)||e.isKeyReleased(n.TOUCH_RETRY))&&(this.retryKeyReleased=!0);return}if(!this.player)return;if(this.player.update(t),this.isMobileDevice()&&(this.player.setVelocityX(this.player.getMoveSpeed()*.7),e.isKeyJustPressed(n.TOUCH_JUMP))){const h=e.getTouchX(),o=e.getTouchY();if(h>=10&&h<=110&&o>=30&&o<=70){this.backToMenuRequested=!0;return}}if(e.isKeyPressed(n.TOUCH_JUMP)&&this.player.isOnGroundState()){const h=e.getTouchX(),o=e.getTouchY();h>=10&&h<=110&&o>=30&&o<=70||this.player.jump()}let i=!1;for(const h of this.grounds)if(this.player.getVelocityY()>0&&this.player.getY()+this.player.getHeight()>=h.getY()-5&&this.player.getY()+this.player.getHeight()<=h.getY()+10&&this.player.getX()+this.player.getWidth()>h.getX()&&this.player.getX()<h.getX()+h.getWidth()){this.player.setPosition(this.player.getX(),h.getY()-this.player.getHeight()),this.player.setVelocityY(0),this.player.setOnGround(!0),i=!0;break}!i&&!this.player.isOnGroundState()&&this.player.setOnGround(!1);for(const h of this.traps)if(T.checkCollision(this.player.getRect(),h.getRect())){this.gameState=1,this.endTime=performance.now(),this.retryKeyReleased=!1;return}if(this.treasure&&T.checkCollision(this.player.getRect(),this.treasure.getRect())){this.gameState=2,this.endTime=performance.now(),this.retryKeyReleased=!1;return}if(this.player&&this.game&&this.player.getY()>this.game.getCanvas().height){this.gameState=1,this.endTime=performance.now(),this.retryKeyReleased=!1;return}this.cameraX+=this.autoScrollSpeed*t;const r=this.cameraX+50;if(this.player.getX()<r&&this.player.setPosition(r,this.player.getY()),this.cameraX<0&&(this.cameraX=0),this.treasure&&this.game&&this.cameraX>this.levelWidth-this.game.getCanvas().width-100){const h=this.player.getX()+this.autoMoveSpeed*t;this.player.setPosition(h,this.player.getY())}e.update()}render(t){if(!this.game||!this.player)return;const e=this.game.getCanvas();t.fillStyle="#87CEEB",t.fillRect(0,0,e.width,e.height),t.save(),t.translate(-this.cameraX,0);for(const i of this.grounds)i.render(t);for(const i of this.traps)i.render(t);this.treasure&&this.treasure.render(t),this.player.render(t),t.restore(),this.renderUI(t)}renderUI(t){if(!this.game)return;const e=this.game.getCanvas();if(this.gameState===1&&(t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(0,0,e.width,e.height),t.fillStyle="#ffffff",t.font="36px Arial",t.textAlign="center",t.fillText("ゲームオーバー",e.width/2,e.height/2-40),t.font="24px Arial",this.isMobileDevice()?t.fillText("画面をタップしてリトライ",e.width/2,e.height/2+20):t.fillText("スペースキーでリトライ",e.width/2,e.height/2+20),t.font="18px Arial",t.fillText("ESCキーでメニューに戻る",e.width/2,e.height/2+60)),this.gameState===2){const i=(this.endTime-this.startTime)/1e3;t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(0,0,e.width,e.height),t.fillStyle="#ffffff",t.font="36px Arial",t.textAlign="center",t.fillText("ゲームクリア！",e.width/2,e.height/2-60),t.font="24px Arial",t.fillText(`クリア時間: ${i.toFixed(2)}秒`,e.width/2,e.height/2),this.isMobileDevice()?t.fillText("画面をタップしてリトライ",e.width/2,e.height/2+40):t.fillText("スペースキーでリトライ",e.width/2,e.height/2+40),t.font="18px Arial",t.fillText("ESCキーでメニューに戻る",e.width/2,e.height/2+80)}this.gameState===0&&(t.fillStyle="rgba(0, 0, 0, 0.5)",t.font="14px Arial",t.textAlign="left",t.fillText("ESC: メニューに戻る",10,20),this.isMobileDevice()&&(t.fillStyle="rgba(255, 0, 0, 0.7)",t.fillRect(10,30,100,40),t.fillStyle="#FFFFFF",t.font="18px Arial",t.textAlign="center",t.fillText("戻る",60,55)))}returnToMenu(){if(!this.game)return;const t=new b;this.game.setScene(t)}isMobileDevice(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}reset(){this.game&&this.init(this.game)}}export{G as GameScene};
